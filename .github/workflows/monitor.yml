name: Monitor Liara.ir JS Changes

on:
  schedule:
    - cron: '*/30 * * * *'  # هر 30 دقیقه اجرا بشه (UTC)
  workflow_dispatch:       # برای اجرای دستی

jobs:
  monitor:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Create directories
        run: |
          mkdir -p chunks/pages
          mkdir -p chunks

      - name: Download all JS files from /_next/static/chunks/pages/
        run: |
          curl -s https://liara.ir/_next/static/chunks/pages/ > pages.html
          grep -o '"[^"]*\.js"' pages.html | tr -d '"' | while read file; do
            full_url="https://liara.ir/_next/static/chunks/pages/$file"
            filename=$(basename "$file")
            echo "Downloading $full_url"
            curl -s -L "$full_url" -o "chunks/pages/$filename" || echo "Failed: $file"
          done

      - name: Download all JS files from /_next/static/chunks/ (main files)
        run: |
          curl -s https://liara.ir/_next/static/chunks/ > chunks.html
          grep -o '"[^"]*\.js"' chunks.html | tr -d '"' | while read file; do
            full_url="https://liara.ir/_next/static/chunks/$file"
            filename=$(basename "$file")
            echo "Downloading $full_url"
            curl -s -L "$full_url" -o "chunks/$filename" || echo "Failed: $file"
          done

      - name: Remove temp HTML files
        run: rm -f pages.html chunks.html

      - name: Commit and push if changed
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Auto-update: JS files changed on liara.ir"
          file_pattern: 'chunks/**/*.js'
          commit_user_name: "Liara Monitor Bot"
          commit_user_email: "bot@liara.ir"
          commit_author: "Liara Monitor <bot@liara.ir>"
