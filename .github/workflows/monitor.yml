name: Monitor Liara.ir JS Changes

on:
  schedule:
    - cron: '*/30 * * * *'
  workflow_dispatch:

jobs:
  monitor:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Create chunks folder
        run: mkdir -p chunks

      - name: Get buildId from homepage
        id: build
        run: |
          BUILD_ID=$(curl -s https://liara.ir | grep -o '"buildId":"[^"]*"' | head -1 | cut -d'"' -f4)
          if [ -z "$BUILD_ID" ]; then
            echo "خطا: buildId پیدا نشد!"
            exit 1
          fi
          echo "build_id=$BUILD_ID" >> $GITHUB_OUTPUT
          echo "buildId پیدا شد: $BUILD_ID"

      - name: Download _buildManifest.js
        run: |
          URL="https://liara.ir/_next/static/${{ steps.build.outputs.build_id }}/_buildManifest.js"
          echo "دانلود از: $URL"
          curl -f -L "$URL" -o chunks/_buildManifest.js || exit 1

      - name: Extract JS paths
        run: |
          grep -o '/_next/static/[^"]*\.js' chunks/_buildManifest.js | sort -u > js_paths.txt
          echo "تعداد فایل JS: $(wc -l < js_paths.txt)"

      - name: Download all JS files
        run: |
          cat js_paths.txt | while read path; do
            url="https://liara.ir$path"
            file="chunks${path#_next/static}"
            mkdir -p "$(dirname "$file")"
            curl -f -L "$url" -o "$file" || echo "Failed: $url"
          done

      - name: Beautify JS files
        run: |
          npm install -g js-beautify
          find chunks -name "*.js" -exec js-beautify -r {} \; || true

      - name: Commit if changed
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Liara.ir updated (build: ${{ steps.build.outputs.build_id }})"
          file_pattern: chunks
