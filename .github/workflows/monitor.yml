name: Monitor Liara.ir JS Changes

on:
  schedule:
    - cron: '*/30 * * * *'  # هر 30 دقیقه
  workflow_dispatch:       # اجرای دستی

jobs:
  monitor:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Create chunks folder
        run: mkdir -p chunks

      - name: Get current buildId
        id: build
        run: |
          BUILD_ID=$(curl -s https://liara.ir/_next/static/uYRRPmLwT2JSAONXJU0Yq/_buildManifest.js | grep -o '"buildId":"[^"]*"' | head -1 | cut -d'"' -f4)
          echo "build_id=$BUILD_ID" >> $GITHUB_OUTPUT
          echo "Current buildId: $BUILD_ID"

      - name: Download _buildManifest.js
        run: |
          curl -f -L "https://liara.ir/_next/static/${{ steps.build.outputs.build_id }}/_buildManifest.js" -o chunks/_buildManifest.js

      - name: Extract all JS file paths
        run: |
          grep -o '/_next/static/[^"]*\.js' chunks/_buildManifest.js | sort -u > js_paths.txt

      - name: Download all JS files
        run: |
          cat js_paths.txt | while read path; do
            url="https://liara.ir$path"
            file="chunks${path#_next/static}"
            mkdir -p "$(dirname "$file")"
            echo "Downloading $url → $file"
            curl -f -L "$url" -o "$file" || echo "Failed: $url"
          done

      - name: Beautify all JS files (make readable)
        run: |
          npm install -g js-beautify
          find chunks -name "*.js" -exec js-beautify -r {} \;

      - name: Commit changes if any
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Liara.ir JS updated (build: ${{ steps.build.outputs.build_id }})"
          file_pattern: chunks
          skip_dirty_check: false
